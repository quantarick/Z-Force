<apex:page controller="zqu.LookupBrowseController" sidebar="false"
  showheader="false">
  <script language="javascript">
   window.onload = new function() 
   { 
      // bring popup window to front
      window.focus(); 
      var ele=document.getElementById('{!$Component.form.block.section.query}');
      if (ele)
      {
         ele.focus();
      }
   }
   
   function fillIn(name, id)
   {
     var winMain = window.opener; 
     if ( winMain == null ) winMain = window.parent.opener; 
     
     var nameElement = winMain.document.getElementById('{!JSENCODE($CurrentPage.parameters.namefield)}');
     var nameDisplayElement = winMain.document.getElementById( '{!JSENCODE($CurrentPage.parameters.namefield)}Display' );
     var idElement = winMain.document.getElementById('{!JSENCODE($CurrentPage.parameters.idfield)}');
     
     nameElement.value = name; 
     nameDisplayElement.value = name; 
     idElement.value = id;   
     
     winMain.change{!JSENCODE($CurrentPage.parameters.fieldId)}();
     
     CloseWindow();
   }
   
   function CloseWindow()
   {
      var winMain=window.opener;
      if (null==winMain)
      {
         winMain=window.parent.opener;
      }
      winMain.closeLookupPopup();
   }
</script>

  <apex:messages />
  <apex:form id="form">

    <div style="width: 100%">
      <apex:pageBlock title="{!injectedController.lookupPageTitle}" id="block">
        <apex:outputText value="Search: " />
        <apex:inputText title="Search" value="{!injectedController.searchString}" id="query" />
        <apex:commandButton value="Go" action="{!injectedController.executeQuery}" />
        <apex:commandButton value="Clear" action="{!injectedController.clearState}" />
      </apex:pageBlock>

      <apex:outputPanel id="results">
        <apex:pageBlock title="Search Results">
        <apex:panelGrid columns="2">
          <apex:commandLink action="{!injectedController.lookupSetController.previous}"
            rendered="{!injectedController.lookupSetController.hasPrevious}">Previous</apex:commandlink>
            <apex:commandLink action="{!injectedController.lookupSetController.next}"
              rendered="{!injectedController.lookupSetController.hasNext}">Next</apex:commandlink>
        </apex:panelGrid>
          <apex:pageBlockSection columns="1">
            <apex:pageBlockTable value="{!injectedController.lookupRecords}" var="rec">
              <apex:repeat value="{!injectedController.displayFields}" var="field">
                <apex:column headerValue="{!injectedController.fieldLabelMap[field]}">
                  <apex:outputLink rendered="{!(field == 'Name')}" value="#"
                    onclick="fillIn('{!rec['Name']}', '{!rec['Id']}')">{!rec['Name']}</apex:outputLink>
                  <apex:outputField rendered="{! NOT(field == 'Name')}"
                    value="{!rec[field]}" />
                </apex:column>
              </apex:repeat>
            </apex:pageBlockTable>
          </apex:pageBlockSection>

          <apex:panelGrid columns="2">
            <apex:commandLink action="{!injectedController.lookupSetController.previous}"
              rendered="{!injectedController.lookupSetController.hasPrevious}">Previous</apex:commandlink>
              <apex:commandLink action="{!injectedController.lookupSetController.next}"
                rendered="{!injectedController.lookupSetController.hasNext}">Next</apex:commandlink>
          </apex:panelGrid>
        </apex:pageBlock>
      </apex:outputPanel>
      <!-- 
      <button type="button" onclick="CloseWindow();">Close Window</button>
       -->
    </div>
  </apex:form>
</apex:page>